# @claude-chat/db

Database abstraction layer for the ccluster chat application. This package provides a unified `ChatRepository` interface with swappable backend implementations, allowing the application to run against SQLite, PostgreSQL, MySQL, or MongoDB without changing any business logic.

## Package overview

The package follows a repository pattern with a factory function. All four database backends implement the same `ChatRepository` interface, which covers CRUD operations for chats, messages, users, and API keys. SQL backends (SQLite, PostgreSQL, MySQL) use [Drizzle ORM](https://orm.drizzle.team/) with driver-specific schema definitions, while the MongoDB backend uses the official MongoDB Node.js driver directly.

### Directory structure

```
src/
  index.ts                  # Public exports (createRepository, ChatRepository, DbConfig, DbDriver)
  repository.ts             # ChatRepository interface definition
  factory.ts                # createRepository() factory + DbConfig / DbDriver types
  sql/
    schema-sqlite.ts        # Drizzle schema for SQLite (better-sqlite3)
    schema-pg.ts            # Drizzle schema for PostgreSQL (node-postgres)
    schema-mysql.ts         # Drizzle schema for MySQL (mysql2)
    sqlite-repository.ts    # SqliteRepository implementation
    pg-repository.ts        # PgRepository implementation
    mysql-repository.ts     # MysqlRepository implementation
  mongo/
    mongo-repository.ts     # MongoRepository implementation
  __tests__/
    sqlite-repository.test.ts   # Unit tests (vitest, in-memory SQLite)
```

## Supported databases

| Driver     | npm dependency     | Drizzle adapter               | Notes                                          |
| ---------- | ------------------ | ----------------------------- | ---------------------------------------------- |
| `sqlite`   | `better-sqlite3`   | `drizzle-orm/better-sqlite3`  | Synchronous, file-based or `:memory:`. No `init()` call needed. |
| `postgres` | `pg`               | `drizzle-orm/node-postgres`   | Uses `pg.Pool`. Requires `init()` for table creation.           |
| `mysql`    | `mysql2`           | `drizzle-orm/mysql2`          | Uses `mysql2/promise` pool. Requires `init()` for table creation. |
| `mongodb`  | `mongodb`          | N/A (native driver)           | Uses `MongoClient`. Requires `init()` for connection and index creation. |

All SQL backends auto-create tables on initialization via `CREATE TABLE IF NOT EXISTS` statements. The MongoDB backend creates indexes on `init()` for `messages.chatId`, `chats.updatedAt`, `chats.userId`, `users.username` (unique), `apiKeys.keyHash` (unique), and `apiKeys.userId`.

## Schema description

The database contains four tables (or collections in MongoDB):

### chats

| Column       | Type   | Constraints              | Description                                |
| ------------ | ------ | ------------------------ | ------------------------------------------ |
| `id`         | TEXT   | PRIMARY KEY              | UUID v4, generated by the application      |
| `title`      | TEXT   | NOT NULL                 | Chat title (defaults to `"New Chat"`)      |
| `session_id` | TEXT   | nullable                 | Associated Claude agent session identifier |
| `user_id`    | TEXT   | NOT NULL, default `'system'` | Owner user ID                          |
| `created_at` | TEXT   | NOT NULL                 | ISO 8601 timestamp                         |
| `updated_at` | TEXT   | NOT NULL                 | ISO 8601 timestamp, updated on any change  |

### messages

| Column       | Type   | Constraints | Description                                      |
| ------------ | ------ | ----------- | ------------------------------------------------ |
| `id`         | TEXT   | PRIMARY KEY | UUID v4                                          |
| `chat_id`    | TEXT   | NOT NULL    | Foreign reference to `chats.id`                  |
| `role`       | TEXT   | NOT NULL    | Either `"user"` or `"assistant"`                 |
| `content`    | TEXT   | NOT NULL    | JSON-stringified `MessageContent[]` array        |
| `created_at` | TEXT   | NOT NULL    | ISO 8601 timestamp                               |
| `metadata`   | TEXT   | nullable    | JSON-stringified `MessageMetadata` (tokens, cost, model, duration) |

### users

| Column          | Type   | Constraints          | Description         |
| --------------- | ------ | -------------------- | ------------------- |
| `id`            | TEXT   | PRIMARY KEY          | UUID v4             |
| `username`      | TEXT   | NOT NULL, UNIQUE     | Login username      |
| `password_hash` | TEXT   | NOT NULL             | Hashed password     |
| `created_at`    | TEXT   | NOT NULL             | ISO 8601 timestamp  |
| `updated_at`    | TEXT   | NOT NULL             | ISO 8601 timestamp  |

### api_keys

| Column         | Type   | Constraints          | Description                         |
| -------------- | ------ | -------------------- | ----------------------------------- |
| `id`           | TEXT   | PRIMARY KEY          | UUID v4                             |
| `user_id`      | TEXT   | NOT NULL             | Owner user ID                       |
| `key_hash`     | TEXT   | NOT NULL, UNIQUE     | SHA hash of the raw API key         |
| `key_prefix`   | TEXT   | NOT NULL             | Short prefix for display (e.g. `cck_abc`) |
| `name`         | TEXT   | NOT NULL             | Human-readable key name             |
| `created_at`   | TEXT   | NOT NULL             | ISO 8601 timestamp                  |
| `last_used_at` | TEXT   | nullable             | ISO 8601 timestamp of last use      |
| `revoked_at`   | TEXT   | nullable             | ISO 8601 timestamp if revoked       |

> **Note:** The MySQL schema uses `VARCHAR` with explicit lengths for primary keys and indexed columns (e.g. `VARCHAR(36)` for UUIDs, `VARCHAR(255)` for usernames) instead of `TEXT`.

## Repository interface

The `ChatRepository` interface exposes the following methods. All methods are asynchronous and return Promises.

### Chat operations

All chat operations are scoped to a `userId` to enforce multi-tenant isolation.

| Method | Signature | Description |
| ------ | --------- | ----------- |
| `createChat` | `(input: CreateChatInput, userId: string) => Promise<Chat>` | Create a new chat. Title defaults to `"New Chat"` if omitted. |
| `getChat` | `(id: string, userId: string) => Promise<Chat \| null>` | Retrieve a single chat by ID. Returns `null` if not found or belongs to a different user. |
| `listChats` | `(userId: string, params?: PaginationParams) => Promise<{ chats: Chat[]; total: number }>` | List chats ordered by most recently updated. Supports `limit` and `offset` pagination (default page size: 50). |
| `updateChat` | `(id: string, userId: string, input: UpdateChatInput) => Promise<Chat \| null>` | Update a chat's title. Returns the updated chat or `null` if not found. |
| `deleteChat` | `(id: string, userId: string) => Promise<boolean>` | Delete a chat and all its messages. Returns `true` on success, `false` if not found. |
| `setChatSession` | `(chatId: string, sessionId: string) => Promise<void>` | Attach a Claude agent session ID to a chat. |

### Message operations

| Method | Signature | Description |
| ------ | --------- | ----------- |
| `addMessage` | `(chatId: string, role: "user" \| "assistant", content: MessageContent[], metadata?: MessageMetadata) => Promise<Message>` | Append a message to a chat. Also updates the chat's `updatedAt` timestamp. |
| `getMessages` | `(chatId: string, params?: PaginationParams) => Promise<{ messages: Message[]; total: number }>` | List messages for a chat in chronological order with pagination support. |
| `getMessage` | `(id: string) => Promise<Message \| null>` | Retrieve a single message by ID. |

### User operations

| Method | Signature | Description |
| ------ | --------- | ----------- |
| `createUser` | `(username: string, passwordHash: string) => Promise<User>` | Register a new user. The caller is responsible for hashing the password. |
| `getUserByUsername` | `(username: string) => Promise<(User & { passwordHash: string }) \| null>` | Look up a user by username. Returns the password hash for authentication. |
| `getUserById` | `(id: string) => Promise<User \| null>` | Look up a user by ID. Does not include the password hash. |

### API key operations

| Method | Signature | Description |
| ------ | --------- | ----------- |
| `createApiKey` | `(userId: string, keyHash: string, keyPrefix: string, name: string) => Promise<ApiKey>` | Store a new API key. The caller hashes the raw key before passing `keyHash`. |
| `getApiKeyByHash` | `(keyHash: string) => Promise<(ApiKey & { userId: string }) \| null>` | Find an active (non-revoked) API key by its hash. Returns `null` if revoked or not found. |
| `listApiKeys` | `(userId: string) => Promise<ApiKey[]>` | List all API keys (including revoked) for a user, ordered by creation date descending. |
| `revokeApiKey` | `(id: string, userId: string) => Promise<boolean>` | Soft-revoke an API key by setting `revokedAt`. Returns `false` if not found. |
| `updateApiKeyLastUsed` | `(id: string) => Promise<void>` | Update the `lastUsedAt` timestamp for an API key. |

## Configuration

### DbConfig

The `createRepository` factory accepts a `DbConfig` object:

```typescript
interface DbConfig {
  driver: "sqlite" | "postgres" | "mysql" | "mongodb";
  sqlitePath?: string;      // Required when driver is "sqlite"
  postgresUrl?: string;     // Required when driver is "postgres"
  mysqlUrl?: string;        // Required when driver is "mysql"
  mongodbUrl?: string;      // Required when driver is "mongodb"
  mongodbName?: string;     // Optional database name for MongoDB
}
```

### Environment variables

The configuration values are typically sourced from environment variables by the consuming application. The recommended mapping is:

| Variable           | DbConfig field  | Example value                                      |
| ------------------ | --------------- | -------------------------------------------------- |
| `DB_DRIVER`        | `driver`        | `sqlite`, `postgres`, `mysql`, or `mongodb`        |
| `SQLITE_PATH`      | `sqlitePath`    | `./data/chat.db` or `:memory:`                     |
| `POSTGRES_URL`     | `postgresUrl`   | `postgresql://user:pass@localhost:5432/ccluster`   |
| `MYSQL_URL`        | `mysqlUrl`      | `mysql://user:pass@localhost:3306/ccluster`        |
| `MONGODB_URL`      | `mongodbUrl`    | `mongodb://localhost:27017/ccluster`               |
| `MONGODB_DB_NAME`  | `mongodbName`   | `ccluster`                                         |

## Usage example

```typescript
import { createRepository } from "@claude-chat/db";
import type { ChatRepository, DbConfig } from "@claude-chat/db";

// Configure for SQLite (simplest setup)
const config: DbConfig = {
  driver: "sqlite",
  sqlitePath: "./data/chat.db",
};

// Or configure from environment variables
// const config: DbConfig = {
//   driver: process.env.DB_DRIVER as DbConfig["driver"],
//   sqlitePath: process.env.SQLITE_PATH,
//   postgresUrl: process.env.POSTGRES_URL,
//   mysqlUrl: process.env.MYSQL_URL,
//   mongodbUrl: process.env.MONGODB_URL,
//   mongodbName: process.env.MONGODB_DB_NAME,
// };

const repo: ChatRepository = await createRepository(config);

// Create a user
const user = await repo.createUser("alice", "hashed-password-here");

// Create a chat
const chat = await repo.createChat({ title: "My first chat" }, user.id);

// Add messages
await repo.addMessage(chat.id, "user", [{ type: "text", text: "Hello!" }]);
await repo.addMessage(
  chat.id,
  "assistant",
  [{ type: "text", text: "Hi there! How can I help you?" }],
  { model: "claude-3-opus-20240229", inputTokens: 12, outputTokens: 18 }
);

// Retrieve messages
const { messages, total } = await repo.getMessages(chat.id);
console.log(`${total} messages in chat`);

// List chats with pagination
const { chats } = await repo.listChats(user.id, { limit: 10, offset: 0 });

// API key management
const apiKey = await repo.createApiKey(user.id, "sha256-hash", "cck_abc", "My API Key");
const found = await repo.getApiKeyByHash("sha256-hash");
await repo.updateApiKeyLastUsed(apiKey.id);
await repo.revokeApiKey(apiKey.id, user.id);
```

## Scripts

| Command              | Description                          |
| -------------------- | ------------------------------------ |
| `npm run build`      | Compile TypeScript to `dist/`        |
| `npm run dev`        | Watch mode TypeScript compilation    |
| `npm run lint`       | Type-check without emitting          |
| `npm run typecheck`  | Type-check without emitting          |
| `npm run test`       | Run tests with vitest                |
| `npm run test:watch` | Run tests in watch mode              |
